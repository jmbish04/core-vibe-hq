---
description: "Database technologies - Drizzle ORM and Kysely usage, migration management"
globs:
  - "orchestrator/**/*.ts"
  - "orchestrator/**/*.sql"
  - "orchestrator/drizzle.config.*.ts"
alwaysApply: true
---

# Database Technologies

## Drizzle ORM and Kysely

**All D1 database operations MUST use Drizzle ORM and Kysely:**

- ✅ **Schema Definition**: Use Drizzle ORM (`sqliteTable`, `text`, `integer`, etc.) in `orchestrator/worker/database/schema.ts`
- ✅ **Queries**: Use Drizzle ORM for queries (`db.db.select()`, `db.db.insert()`, etc.)
- ✅ **Type Safety**: Use Kysely types where needed (e.g., `Selectable<TasksTable>`)
- ❌ **Never**: Use raw SQL queries or `env.DB.prepare()` directly
- ❌ **Never**: Use raw SQL in migrations - migrations are auto-generated by Drizzle Kit from schema definitions

## Migration Management

**Migrations folder location:**
- ✅ **Only**: `orchestrator/migrations/` contains SQL migration files
- ❌ **Never**: Create migrations folders under `apps/` or factories
- ❌ **Never**: Manually create SQL migration files - use Drizzle Kit to generate from schema

**Migration Workflow:**
1. Define/update tables in `orchestrator/worker/database/schema.ts` using Drizzle ORM
2. Run `npm run db:generate` in orchestrator directory
3. Drizzle Kit automatically generates SQL migration files in `orchestrator/migrations/`
4. Apply migrations with `npm run db:migrate:local` or `npm run db:migrate:remote`
