#!/bin/bash
# patchctl - Wrapper for patch_manager.py
# Provides a convenient command-line interface for patch operations

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PATCH_MANAGER="${SCRIPT_DIR}/patch_manager.py"

function show_help {
    cat << EOF
Usage: patchctl [command] [options]

Commands:
  apply [patch-file]     Apply a patch batch from a JSON file
  list                   List available patches (placeholder)
  validate [patch-file]  Validate a patch without applying it
  revert [patch-id]      Revert an applied patch (placeholder)
  notify [patch-id]      Send notification to orchestrator only

Options:
  --dry-run              Show changes without applying them
  --orchestrator-url URL URL of the orchestrator service
  --project-root PATH    Root directory of the project
  --help                 Show this help message

Examples:
  patchctl apply patches/my-patch.json
  patchctl apply patches/my-patch.json --dry-run
  patchctl validate patches/my-patch.json
  patchctl notify test-patch-123

Environment Variables:
  ORCHESTRATOR_URL       Default orchestrator URL (default: http://localhost:8787)

EOF
}

function check_dependencies {
    if ! command -v python3 &> /dev/null; then
        echo "Error: python3 is not installed" >&2
        exit 1
    fi
    
    if [ ! -f "$PATCH_MANAGER" ]; then
        echo "Error: patch_manager.py not found at $PATCH_MANAGER" >&2
        exit 1
    fi
}

function apply_patch {
    local patch_file="$1"
    shift
    
    if [ ! -f "$patch_file" ]; then
        echo "Error: Patch file not found: $patch_file" >&2
        exit 1
    fi
    
    python3 "$PATCH_MANAGER" --apply "$patch_file" "$@"
}

function validate_patch {
    local patch_file="$1"
    shift
    
    if [ ! -f "$patch_file" ]; then
        echo "Error: Patch file not found: $patch_file" >&2
        exit 1
    fi
    
    # Validate by running in dry-run mode
    python3 "$PATCH_MANAGER" --apply "$patch_file" --dry-run "$@"
    echo ""
    echo "âœ“ Patch validation passed (dry-run mode)"
}

function list_patches {
    echo "Listing available patches..."
    echo ""
    echo "Note: This feature is a placeholder. In the future, this will:"
    echo "  - Scan for patch files in configured directories"
    echo "  - Query orchestrator for applied patches"
    echo "  - Show patch history and status"
    echo ""
    echo "For now, use 'find' to locate patch files:"
    echo "  find . -name '*.patch.json' -o -name '*patch*.json'"
}

function revert_patch {
    local patch_id="$1"
    
    echo "Reverting patch: $patch_id"
    echo ""
    echo "Note: Revert functionality is a placeholder. In the future, this will:"
    echo "  - Query orchestrator for patch history"
    echo "  - Generate reverse patches"
    echo "  - Apply reverse patches to restore original state"
    echo ""
    echo "For now, use git to revert changes:"
    echo "  git checkout <commit-before-patch>"
}

function notify_orchestrator {
    local patch_id="$1"
    shift
    
    python3 "$PATCH_MANAGER" --notify-only "$@" --patch-id "$patch_id" 2>/dev/null || {
        echo "Note: Notification-only mode requires additional setup"
        echo "Use: python3 $PATCH_MANAGER --notify-only"
    }
}

# Main command routing
check_dependencies

case "${1:-}" in
    apply)
        if [ -z "${2:-}" ]; then
            echo "Error: Patch file required for 'apply' command" >&2
            echo "Usage: patchctl apply <patch-file>" >&2
            exit 1
        fi
        apply_patch "$2" "${@:3}"
        ;;
    validate)
        if [ -z "${2:-}" ]; then
            echo "Error: Patch file required for 'validate' command" >&2
            echo "Usage: patchctl validate <patch-file>" >&2
            exit 1
        fi
        validate_patch "$2" "${@:3}"
        ;;
    list)
        list_patches
        ;;
    revert)
        if [ -z "${2:-}" ]; then
            echo "Error: Patch ID required for 'revert' command" >&2
            echo "Usage: patchctl revert <patch-id>" >&2
            exit 1
        fi
        revert_patch "$2"
        ;;
    notify)
        if [ -z "${2:-}" ]; then
            echo "Error: Patch ID required for 'notify' command" >&2
            echo "Usage: patchctl notify <patch-id>" >&2
            exit 1
        fi
        notify_orchestrator "$2" "${@:3}"
        ;;
    --help|-h|help)
        show_help
        ;;
    "")
        echo "Error: No command specified" >&2
        echo ""
        show_help
        exit 1
        ;;
    *)
        echo "Error: Unknown command: $1" >&2
        echo ""
        show_help
        exit 1
        ;;
esac

