name: Meta Deploy - Shared Package Changes

on:
  push:
    branches:
      - main
    paths:
      - 'packages/shared-types/**'
      - 'packages/memory-library/**'
    tags:
      - 'packages/**'
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to trigger deployments for'
        required: true
        type: choice
        options:
          - shared-types
          - memory-library
          - all
      force:
        description: 'Force redeploy all workers regardless of changes'
        required: false
        type: boolean
        default: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      shared-types-changed: ${{ steps.changes.outputs.shared-types }}
      memory-library-changed: ${{ steps.changes.outputs.memory-library }}
      should-deploy-orchestrator: ${{ steps.changes.outputs.should-deploy-orchestrator }}
      should-deploy-agent: ${{ steps.changes.outputs.should-deploy-agent }}
      should-deploy-data: ${{ steps.changes.outputs.should-deploy-data }}
      should-deploy-services: ${{ steps.changes.outputs.should-deploy-services }}
      should-deploy-ui: ${{ steps.changes.outputs.should-deploy-ui }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect package changes
        id: changes
        run: |
          # Initialize all outputs to false
          echo "shared-types=false" >> $GITHUB_OUTPUT
          echo "memory-library=false" >> $GITHUB_OUTPUT
          echo "should-deploy-orchestrator=false" >> $GITHUB_OUTPUT
          echo "should-deploy-agent=false" >> $GITHUB_OUTPUT
          echo "should-deploy-data=false" >> $GITHUB_OUTPUT
          echo "should-deploy-services=false" >> $GITHUB_OUTPUT
          echo "should-deploy-ui=false" >> $GITHUB_OUTPUT
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.package }}" = "shared-types" ] || [ "${{ github.event.inputs.package }}" = "all" ] || [ "${{ github.event.inputs.force }}" = "true" ]; then
              echo "shared-types=true" >> $GITHUB_OUTPUT
              echo "should-deploy-orchestrator=true" >> $GITHUB_OUTPUT
              echo "should-deploy-agent=true" >> $GITHUB_OUTPUT
              echo "should-deploy-data=true" >> $GITHUB_OUTPUT
              echo "should-deploy-services=true" >> $GITHUB_OUTPUT
              echo "should-deploy-ui=true" >> $GITHUB_OUTPUT
            fi
            if [ "${{ github.event.inputs.package }}" = "memory-library" ] || [ "${{ github.event.inputs.package }}" = "all" ] || [ "${{ github.event.inputs.force }}" = "true" ]; then
              echo "memory-library=true" >> $GITHUB_OUTPUT
              echo "should-deploy-orchestrator=true" >> $GITHUB_OUTPUT
              echo "should-deploy-agent=true" >> $GITHUB_OUTPUT
            fi
          else
            # Check for package changes in this commit
            if git diff --name-only HEAD~1 HEAD | grep -q "^packages/shared-types/"; then
              echo "shared-types=true" >> $GITHUB_OUTPUT
              echo "should-deploy-orchestrator=true" >> $GITHUB_OUTPUT
              echo "should-deploy-agent=true" >> $GITHUB_OUTPUT
              echo "should-deploy-data=true" >> $GITHUB_OUTPUT
              echo "should-deploy-services=true" >> $GITHUB_OUTPUT
              echo "should-deploy-ui=true" >> $GITHUB_OUTPUT
            fi
            if git diff --name-only HEAD~1 HEAD | grep -q "^packages/memory-library/"; then
              echo "memory-library=true" >> $GITHUB_OUTPUT
              echo "should-deploy-orchestrator=true" >> $GITHUB_OUTPUT
              echo "should-deploy-agent=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Display deployment plan
        run: |
          echo "ðŸ“¦ Package Changes Detected:"
          echo "  - shared-types: ${{ steps.changes.outputs.shared-types-changed }}"
          echo "  - memory-library: ${{ steps.changes.outputs.memory-library-changed }}"
          echo ""
          echo "ðŸš€ Workers to Deploy:"
          echo "  - orchestrator: ${{ steps.changes.outputs.should-deploy-orchestrator }}"
          echo "  - agent-factory: ${{ steps.changes.outputs.should-deploy-agent }}"
          echo "  - data-factory: ${{ steps.changes.outputs.should-deploy-data }}"
          echo "  - services-factory: ${{ steps.changes.outputs.should-deploy-services }}"
          echo "  - ui-factory: ${{ steps.changes.outputs.should-deploy-ui }}"

  deploy-orchestrator:
    needs: detect-changes
    if: needs.detect-changes.outputs.should-deploy-orchestrator == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        working-directory: apps/orchestrator
        run: npm ci
      - name: Build & Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/orchestrator

  deploy-agent-factory:
    needs: detect-changes
    if: needs.detect-changes.outputs.should-deploy-agent == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        working-directory: apps/agent-factory
        run: npm ci || echo "No package.json found, skipping install"
      - name: Build & Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/agent-factory

  deploy-data-factory:
    needs: detect-changes
    if: needs.detect-changes.outputs.should-deploy-data == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        working-directory: apps/data-factory
        run: npm ci || echo "No package.json found, skipping install"
      - name: Run D1 migrations
        working-directory: apps/data-factory
        run: wrangler d1 migrations apply DB --remote
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      - name: Build & Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/data-factory
          preCommands: wrangler d1 migrations apply DB --remote

  deploy-services-factory:
    needs: detect-changes
    if: needs.detect-changes.outputs.should-deploy-services == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        working-directory: apps/services-factory
        run: npm ci || echo "No package.json found, skipping install"
      - name: Build & Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/services-factory

  deploy-ui-factory:
    needs: detect-changes
    if: needs.detect-changes.outputs.should-deploy-ui == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        working-directory: apps/ui-factory
        run: npm ci || echo "No package.json found, skipping install"
      - name: Build & Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/ui-factory

  summary:
    needs: [detect-changes, deploy-orchestrator, deploy-agent-factory, deploy-data-factory, deploy-services-factory, deploy-ui-factory]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸŽ¯ Meta Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Changes" >> $GITHUB_STEP_SUMMARY
          echo "- **shared-types**: ${{ needs.detect-changes.outputs.shared-types-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **memory-library**: ${{ needs.detect-changes.outputs.memory-library-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Worker Deployments" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| orchestrator | ${{ needs.deploy-orchestrator.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| agent-factory | ${{ needs.deploy-agent-factory.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| data-factory | ${{ needs.deploy-data-factory.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| services-factory | ${{ needs.deploy-services-factory.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ui-factory | ${{ needs.deploy-ui-factory.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY

